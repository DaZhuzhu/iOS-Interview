## 1. å¦‚ä½•æ ¹æ®çº¿ä¸Šå´©æºƒæ—¥å¿—è¯Šæ–­æ˜¯å¦æ˜¯é‡æŒ‡é’ˆ

### . æ¦‚å¿µ

å·²ç»è¢«é‡Šæ”¾çš„å¯¹è±¡ï¼Œå…¶æŒ‡é’ˆæ²¡æœ‰è¢«ç½®ä¸º nilï¼Œä¾æ—§æŒ‡å‘åŸæ¥çš„å†…å­˜ç©ºé—´ã€‚

### . **å®è·µæ€»ç»“ï¼šè¯Šæ–­æµç¨‹**

æ‹¿åˆ°ä¸€ä»½çº¿ä¸Šå´©æºƒæ—¥å¿—åï¼Œä½ å¯ä»¥æŒ‰ä»¥ä¸‹æµç¨‹åˆ¤æ–­ï¼š

1. **çœ‹å¼‚å¸¸ç±»å‹**ï¼šæ˜¯å¦æ˜¯ `EXC_BAD_ACCESS (SIGSEGV/SIGBUS)`ï¼Ÿ å¦‚æœæ˜¯ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ã€‚

2. **çœ‹è°ƒç”¨æ ˆé¡¶å±‚**ï¼šæ˜¯å¦æ˜¯ `objc_msgSend`, `objc_release`, `objc_retain` ç­‰è¿è¡Œæ—¶å‡½æ•°ï¼Ÿ å¦‚æœæ˜¯ï¼Œå«Œç–‘æå¤§ã€‚

3. **çœ‹é”™è¯¯åœ°å€**ï¼šæ˜¯å¦æ˜¯ `0xdeadbad00` ç­‰ç‰¹æ®Šå€¼ï¼Ÿ å¦‚æœæ˜¯ï¼ŒåŸºæœ¬ç¡®è¯Šã€‚

4. **ç»“åˆè°ƒç”¨æ ˆä¸Šä¸‹æ–‡**ï¼šå³ä½¿æ²¡æœ‰ç‰¹æ®Šåœ°å€ï¼Œä½†å¦‚æœè°ƒç”¨æ ˆæ˜¾ç¤ºåœ¨æ‰§è¡Œä¸€ä¸ªçœ‹ä¼¼æ­£å¸¸çš„å¯¹è±¡æ–¹æ³•è°ƒç”¨æˆ–é‡Šæ”¾æ“ä½œæ—¶å´©æºƒï¼Œè€Œä½ çš„ä»£ç çœ‹ä¸å‡ºé—®é¢˜ï¼Œä¹Ÿåº”é«˜åº¦æ€€ç–‘æ˜¯é‡æŒ‡é’ˆã€‚

   ```objective-c
   Exception Type:  EXC_BAD_ACCESS (SIGSEGV)
   Exception Codes: KERN_INVALID_ADDRESS at 0x0000000deadbad00
   Crashed Thread:  0
     
   Thread 0 Crashed:
   0   libobjc.A.dylib               0x00000001c5a8b0b8 objc_msgSend + 16
   1   UIKitCore                     0x00000001a2f45a94 -[UIView setNeedsLayout] + 172
   2   YourApp                       0x0000000100aabbcc -[ViewController viewDidAppear:] (ViewController.m:123)
   ...
   æˆ–
   Thread 0 Crashed:
   0   libobjc.A.dylib               0x00000001835590c4 objc_release + 28
   1   CoreFoundation                0x0000000183a0b27c -[__NSArrayI dealloc] + 60
   2   YourApp                       0x0000000100aabbcc -[MyManager dealloc] (MyManager.m:45)
   3   YourApp                       0x0000000100aabc10 -[ViewController setupManager] (ViewController.m:135)
   ...
   ```

   

### . é‡æŒ‡é’ˆå‡ºç°çš„åœºæ™¯

1. assign ä¿®é¥°å¯¹è±¡ï¼ˆéåŸºæœ¬æ•°æ®ç±»å‹ï¼‰ï¼Œassign ä¿®é¥°çš„å¯¹è±¡ä¸ä¼šåœ¨é‡Šæ”¾æ—¶å°†æŒ‡é’ˆç½®ä¸º nil

2. å¤šçº¿ç¨‹å¯¼è‡´é‡æŒ‡é’ˆè®¿é—®

   ä¾‹å­1 

   ```objective-c
   // ğŸš¨ è¯¦ç»†çš„é‡æŒ‡é’ˆåœºæ™¯
   @interface DanglingPointerDemo : NSObject
   @property (nonatomic, strong) NSMutableArray *objects;
   @end
   
   @implementation DanglingPointerDemo
   
   - (void)demonstrateDanglingPointer {
   self.objects = [NSMutableArray array];
   
   // çº¿ç¨‹1ï¼šæ·»åŠ å¯¹è±¡
   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^{
       for (int i = 0; i < 100; i++) {
           // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å¯¹è±¡
           NSString *tempString = [[NSString alloc] initWithFormat:@"Object_%d", i];
           [self.objects addObject:tempString];
           // tempStringåœ¨è¿™é‡Œå¯èƒ½è¢«é‡Šæ”¾ï¼ˆå–å†³äºARCçš„ä¼˜åŒ–ï¼‰
       }
   });
   
   // çº¿ç¨‹2ï¼šç§»é™¤å¯¹è±¡
   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
       while (YES) {
           if (self.objects.count > 0) {
               // ç§»é™¤å¯¹è±¡ï¼Œå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å¯èƒ½å˜ä¸º0
               [self.objects removeObjectAtIndex:0];
           }
       }
   });
   
   // çº¿ç¨‹3ï¼šè¯»å–ï¼ˆä½ æåˆ°çš„ä»£ç ï¼‰
   dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, 0), ^{
       while (YES) {
           @autoreleasepool {
               // ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šcopyæ“ä½œå¯èƒ½åœ¨æ•°ç»„è¢«ä¿®æ”¹æ—¶è¿›è¡Œ
               NSArray *snapshot = [self.objects copy]; // å¯èƒ½å´©æºƒæˆ–å¾—åˆ°æŸåçš„æ•°ç»„ ï¼ˆå…¶å®æ­¤å¤„ä¹Ÿå¯ä»¥ç›´æ¥æ ¹æ® index å–æ•°ç»„é‡Œçš„å€¼æ¥æ¨¡æ‹Ÿé‡æŒ‡é’ˆï¼‰
   
               for (NSString *item in snapshot) {
                   // ç¬¬äºŒä¸ªé—®é¢˜ï¼šå³ä½¿snapshotåˆ›å»ºæˆåŠŸï¼Œitemå¯èƒ½æŒ‡å‘å·²è¢«é‡Šæ”¾çš„å¯¹è±¡
   
                   // åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä»¥ä¸‹æƒ…å†µå¯èƒ½å‘ç”Ÿï¼š
                   // 1. snapshotåˆ›å»ºæ—¶ï¼ŒæŸä¸ªå­—ç¬¦ä¸²å¯¹è±¡è¿˜å­˜åœ¨
                   // 2. ä½†åœ¨è®¿é—®itemæ—¶ï¼Œè¯¥å¯¹è±¡å·²ç»è¢«å…¶ä»–çº¿ç¨‹çš„æ“ä½œé‡Šæ”¾
                   // 3. itemç°åœ¨æ˜¯ä¸€ä¸ªé‡æŒ‡é’ˆ
   
                   NSLog(@"Reading: %@", item); // ğŸ’¥ å¯èƒ½å´©æºƒï¼
               }
           }
       }
   
   });
   }
   @end
   
   è§£é‡Šï¼š
   // æ¨¡æ‹Ÿå†…å­˜çº§åˆ«çš„é—®é¢˜
   /*
   æ—¶é—´çº¿åˆ†æï¼š
   
   T1: çº¿ç¨‹3å¼€å§‹copyæ“ä½œï¼Œè·å–æ•°ç»„å†…éƒ¨æŒ‡é’ˆ
       å†…å­˜çŠ¶æ€ï¼š[0x1000, 0x2000, 0x3000] (æŒ‡å‘ä¸‰ä¸ªå­—ç¬¦ä¸²å¯¹è±¡)
   
   T2: çº¿ç¨‹2ç§»é™¤ç¬¬ä¸€ä¸ªå¯¹è±¡
       - removeObjectAtIndex:0 è¢«è°ƒç”¨
       - 0x1000å¤„çš„å¯¹è±¡å¼•ç”¨è®¡æ•°å‡1
       - å¦‚æœå¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œå¯¹è±¡è¢«é‡Šæ”¾
       - ä½†copyæ“ä½œå¯èƒ½å·²ç»è·å–äº†0x1000è¿™ä¸ªæŒ‡é’ˆ
   
   T3: çº¿ç¨‹3çš„forå¾ªç¯å¼€å§‹æ‰§è¡Œ
       - item = 0x1000 (ä½†è¿™å—å†…å­˜å·²ç»è¢«é‡Šæ”¾)
       - è®¿é—®itemæ—¶å‘ç”Ÿé‡æŒ‡é’ˆè®¿é—®
   
   T4: ğŸ’¥ å´©æºƒæˆ–ä¸å¯é¢„æœŸçš„è¡Œä¸º
   */
   ```

   ä¾‹å­2

   ```objective-c
   // ğŸš¨ é—®é¢˜ä»£ç  - ç½‘ç»œè¯·æ±‚å›è°ƒä¸­çš„é‡æŒ‡é’ˆ
   @interface BadNetworkViewController : UIViewController
   @property (nonatomic, strong) UIImageView *avatarImageView;
   @end
   
   @implementation BadNetworkViewController
   
   - (void)loadUserAvatar {
     NSString *urlString = @"https://example.com/avatar.jpg";
   
     // æ¨¡æ‹Ÿå¼‚æ­¥ç½‘ç»œè¯·æ±‚
     dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
   
   
       // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
       sleep(3);
   
       // å‡è®¾è¿™é‡Œè·å–åˆ°äº†å›¾ç‰‡æ•°æ®
       UIImage *avatarImage = [UIImage imageNamed:@"placeholder"];
   
       dispatch_async(dispatch_get_main_queue(), ^{
           // ğŸš¨ é‡æŒ‡é’ˆé£é™©ï¼3ç§’åselfå¯èƒ½å·²ç»è¢«é‡Šæ”¾
           // å¦‚æœç”¨æˆ·åœ¨ç½‘ç»œè¯·æ±‚å®Œæˆå‰é€€å‡ºäº†é¡µé¢
           self.avatarImageView.image = avatarImage; // å¯èƒ½å´©æºƒ
       });
   
     });
   }
   
   - (void)dealloc {
     NSLog(@"NetworkViewController dealloc");
     // å³ä½¿æ§åˆ¶å™¨è¢«é‡Šæ”¾ï¼Œç½‘ç»œè¯·æ±‚çš„å›è°ƒä»ç„¶ä¼šæ‰§è¡Œ
   }
   @end
   
   ä¿®æ­£ç‰ˆ
   // âœ… å®‰å…¨çš„ç½‘ç»œè¯·æ±‚å®ç°
   @interface SafeNetworkViewController : UIViewController
   @property (nonatomic, strong) UIImageView *avatarImageView;
   @property (nonatomic, strong) NSURLSessionDataTask *imageTask;
   @end
   
   @implementation SafeNetworkViewController
   
   - (void)loadUserAvatar {
       // å–æ¶ˆä¹‹å‰çš„è¯·æ±‚
       [self.imageTask cancel];
       
       NSString *urlString = @"https://example.com/avatar.jpg";
       NSURL *url = [NSURL URLWithString:urlString];
       
       __weak typeof(self) weakSelf = self;
       self.imageTask = [[NSURLSession sharedSession] dataTaskWithURL:url completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
           
           if (error) {
               NSLog(@"Request failed: %@", error);
               return;
           }
           
           UIImage *image = [UIImage imageWithData:data];
           
           dispatch_async(dispatch_get_main_queue(), ^{
               __strong typeof(weakSelf) strongSelf = weakSelf;
               if (strongSelf && strongSelf.avatarImageView) {
                   strongSelf.avatarImageView.image = image;
               }
           });
       }];
       
       [self.imageTask resume];
   }
   
   - (void)dealloc {
       [self.imageTask cancel];
       NSLog(@"SafeNetworkViewController dealloc");
   }
   @end
     
   ```

   

### . è¾…åŠ©å·¥å…·å’ŒæŠ€å·§

- **å¯ç”¨Zombie Objects**ï¼š**è¿™åœ¨å¼€å‘è°ƒè¯•é˜¶æ®µæ˜¯ç»ˆææ­¦å™¨**ã€‚å®ƒä¼šåœ¨è¿è¡Œæ—¶å°†å·²é‡Šæ”¾å¯¹è±¡æ ‡è®°ä¸ºâ€œåƒµå°¸â€ï¼Œè€Œä¸æ˜¯çœŸæ­£é‡Šæ”¾å®ƒä»¬ã€‚å½“ä½ è®¿é—®åƒµå°¸å¯¹è±¡æ—¶ï¼Œä¼šç«‹å³è·å¾—ä¸€ä¸ªæ¸…æ™°çš„é”™è¯¯æŠ¥å‘Šï¼Œæ˜ç¡®æŒ‡å‡º**ä½ è®¿é—®äº†å“ªä¸ªç±»ï¼ˆæœ¬åº”æ˜¯ï¼‰çš„å·²é‡Šæ”¾å¯¹è±¡**ã€‚è¿™åœ¨çº¿ä¸Šæ— æ³•ä½¿ç”¨ï¼Œä½†æœ¬åœ°å¿…ç”¨ã€‚
- **Address Sanitizer (ASan)**ï¼šXcodeæä¾›çš„å¼ºå¤§å†…å­˜è°ƒè¯•å·¥å…·ã€‚å®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶æ£€æµ‹å¤šç§å†…å­˜é”™è¯¯ï¼ŒåŒ…æ‹¬é‡æŒ‡é’ˆè®¿é—®ã€‚å®ƒæ¯”Zombiesæ›´å¼ºå¤§ï¼Œä½†å¯¹æ€§èƒ½å½±å“æ›´å¤§ï¼Œä¹Ÿæ›´é€‚åˆåœ¨å¼€å‘è°ƒè¯•é˜¶æ®µä½¿ç”¨ã€‚
- **çº¿ä¸Šå´©æºƒä¸ŠæŠ¥æœåŠ¡**ï¼šåƒBugly, Firebase Crashlyticsç­‰æœåŠ¡ä¼šè‡ªåŠ¨å¯¹å´©æºƒæ—¥å¿—è¿›è¡Œåˆ†ç»„ã€‚å¦‚æœä½ çœ‹åˆ°å¤§é‡å…·æœ‰ä¸Šè¿°ç‰¹å¾çš„å´©æºƒè¢«å½’ä¸ºåŒä¸€ç±»ï¼Œé‚£ä¹ˆå¾ˆå¤§æ¦‚ç‡å°±æ˜¯åŒä¸€ä¸ªé‡æŒ‡é’ˆé—®é¢˜å¯¼è‡´çš„ã€‚

**æœ€åçš„é‡è¦æç¤º**ï¼šé‡æŒ‡é’ˆé—®é¢˜é€šå¸¸æ˜¯**å¶ç°**çš„ï¼Œå› ä¸ºå¯¹è±¡è¢«é‡Šæ”¾åï¼Œé‚£å—å†…å­˜å¯èƒ½å¾ˆå¿«åˆè¢«å…¶ä»–æ•°æ®è¦†ç›–ã€‚è¿™æ¬¡è®¿é—®å¯èƒ½å´©æºƒï¼Œä¸‹æ¬¡è®¿é—®å¯èƒ½ä¸å´©æºƒï¼Œæˆ–è€…è¡¨ç°å‡ºå¥‡æ€ªçš„è¡Œä¸ºã€‚è¿™ç§ä¸ç¡®å®šæ€§æ­£æ˜¯å®ƒéš¾ä»¥è°ƒè¯•çš„åŸå› ã€‚æ‰€ä»¥å¯¹äºçº¿ä¸Šå¶ç°çš„ `EXC_BAD_ACCESS` å´©æºƒï¼Œè¦ç»™äºˆé«˜åº¦é‡è§†ï¼Œå¹¶ä¼˜å…ˆä½¿ç”¨ä¸Šè¿°æ–¹æ³•è¿›è¡Œæ’æŸ¥ã€‚

### . è§£å†³

æ²¡æœ‰å¾ˆå¥½çš„æ–¹æ³•ï¼ŒåŸºæœ¬ç¡®å®šé‡æŒ‡é’ˆå

## 2. å¸¸è§å´©æºƒç±»å‹ï¼ˆåœºæ™¯ï¼‰

å­çº¿ç¨‹åˆ·æ–°UIã€é”™è¯¯çš„æ–¹æ³•è°ƒç”¨ï¼ˆä¾‹å¦‚nsurlè°ƒç”¨lengthæ–¹æ³•ï¼Œå¤šå‘ç”Ÿäºå‡½æ•°ä¼ å‚ç±»å‹ä¸å¯¹ï¼‰ã€æ•°ç»„è¶Šç•Œã€å‘æ•°ç»„ä¸­æ’å…¥nilã€kvcä¸­ç»™ä¸å­˜åœ¨çš„keyè®¾ç½®valueã€kvoä¸­ç§»é™¤è§‚å¯Ÿè€…çš„æ¬¡æ•°å¤§äºæ³¨å†Œè§‚å¯Ÿè€…çš„æ¬¡æ•°ã€ **é‡æŒ‡é’ˆè®¿é—®**ï¼ˆæµ‹è¯•æœ€éš¾è¦†ç›–åˆ°ï¼Œå› ä¸ºå®ƒä¼šéšæœºcrashï¼‰

## 3. åŠ è½½å¤§å›¾

åˆ©ç”¨ ImageIO æ¡†æ¶åˆ†å—åŠ è½½ï¼Œé¿å…ç¬æ—¶å³°å€¼è§¦å‘OOMã€‚

### Block æ•è·å¯¹è±¡ç›¸å…³

